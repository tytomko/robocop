# 얼굴인식 AI
## Directory
### KNN_database
---  
관리자들의 학습 데이터가 저장되는 폴더
test 디렉토리는 모델 정확도 검증에 사용
   
### sound
---
로봇이 출력할 사운드들을 저장하는 폴더
   
## Code
### main.py
---
knn_training.py, database_update.py, socket_network.py 등의 코드를 통합하여 실행하는 코드.
얼굴 인식 등의 핵심 루프가 main.py에서 구동.
음성이나 소켓 메시지 수신 등은 쓰레드에서 비동기로 작동됨
   
### knn_training.py
---
KNN_database 폴더를 참조하여 KNN 모델을 학습시키는 코드
   
### database_update.py
---
백엔드 서버에서 id, 수정시간, 사진 url을 전송받아 다운로드, 데이터 증강, 저장을 자동화하여 실행하는 코드

### socket_network.py
---
소켓 통신에 관련된 메서드를 제공하는 코드

## 얼굴 인식 과정
우선 신원 확인 및 침입자 감지 알고리즘은 크게 3단계의 분류 task로 이루어집니다.
1단계로 YOLOv8 객체 인식을 통해 화면에 사람이 잡혔는지 판단합니다.
2단계로 CNN 모델을 이용하여 얼굴의 위치를 따오고 ResNet 기반 pre-trained model을 통해 얼굴의 특징 벡터를 추출합니다.
3단계로 KNN 알고리즘을 통해 데이터베이스에 학습된 얼굴과 거리를 비교하여 신원을 확인합니다.

이 과정에서 얼굴을 감지하지 못하는 경우, 얼굴을 감지했으나 조명이나 마스크 등의 문제로 신원을 확인하지 못하는 경우 등을 보완하기 위해 수하 알고리즘을 구현하였습니다.

1. 얼굴을 보고 즉시 신원이 확인된 경우
 -> 관리자로 판단, 신원 확인 처리
2. 얼굴을 감지하였으나 신원을 확인하지 못한 경우, 인물을 감지하였으나 얼굴을 찾아내지 못하는 경우
 -> 로봇 5보 앞에 서달라는 안내와 함께 10초간 얼굴 인식 시도,
 가장 가까운 얼굴과의 거리 x가 임계치(현재 0.33) 이상인 경우 (기본값 / x) * delta_time(프레임과 상관없이 실제 시간에 비례한 값) 
을 계속 더해서 임계치 이상이면 관리자로 판단하여 신원 확인 처리, 10초 안에 인식하지 못하면 2차 인증 요구(현재 미구현)
3. 수하를 요구하였으나 인식하지 못한 상태에서 인물이 사라진 경우
-> 침입자로 판단, 경보 울림.
현재 YOLO가 간헐적으로 인물의 인식이 풀리거나 한명을 두명으로 인식하는 경우가 많아, 
신원확인을 못한 상황에서 화면에 인식한 인물의 숫자가 적어지는 경우가 2초 이상 지속되는 경우에만 침입자 경보를 울림.

일단 화면 내 한명이라도 신원 확인을 성공하면 로봇은 10초간 safe 모드에 진입하여 수하 시도를 하지 않음.
신원 확인 후, 화면을 벗어나는 과정에서 인식이 풀리는데 이 때, 경보가 울리지 않도록 하기 위함.
서비스의 상황 설정을 출입이 제한된 시간과 장소, 출입인원이 극단적으로 적은 장소를 상정하였고, 로봇이 완벽하게 자율적으로 보안을 유지하는 것이 아닌 경비원을 보조하여 인력을 감축하는 것을 목표로 하기 때문에
관리자의 등뒤로 침입자가 순식간에 지나간다던가 하는 상황은 따로 고려하지 않았음.
어차피 그정도 거리면 관리자가 직접 인지하고 대처할 수 있기 때문
