<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lidar Info Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            pointer-events: none;
        }
        .data-container {
            position: absolute;
            right: 10px;
            top: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="info-panel">Points: <span id="point-count">0</span></div>
    <div class="data-container" id="lidarData">
        <h2>라이다 데이터</h2>
        <div id="content">연결 대기중...</div>
    </div>

    <script>
        let scene, camera, renderer, points;
        
        // Three.js 초기화
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);  // 검은 배경
            
            // FOV를 더 넓게 설정하고 far 클리핑 평면을 증가
            camera = new THREE.PerspectiveCamera(
                90,  // FOV를 90도로 증가
                window.innerWidth / window.innerHeight,
                0.1,
                10000  // far 클리핑 평면 증가
            );
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 카메라 위치 조정 - 전체 뷰를 볼 수 있는 위치로
            camera.position.set(0, 30, 0);  // 위에서 내려다보는 시점
            camera.lookAt(0, 0, 0);

            // 그리드 헬퍼 크기 증가
            const gridHelper = new THREE.GridHelper(100, 20, 0x444444, 0x444444);
            scene.add(gridHelper);

            // 좌표축 헬퍼 크기 증가
            const axesHelper = new THREE.AxesHelper(50);
            scene.add(axesHelper);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxDistance = 1000;
            controls.minDistance = 2;
            
            // 초기 회전 설정
            controls.target.set(0, 0, 0);
            camera.up.set(0, 0, 1);  // Z축을 위쪽으로 설정
            
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) {
                controls.update();  // OrbitControls 업데이트
            }
            
            renderer.render(scene, camera);
        }

        // 포인트 클라우드 업데이트
        function updatePointCloud(data) {
            if (!data.points || data.points.length === 0) {
                console.error('No point data available');
                return;
            }

            const vertices = [];
            const colors = [];

            // 포인트 데이터 파싱
            for (let i = 0; i < data.points.length; i++) {
                const point = data.points[i];
                
                // ROS -> Three.js 좌표계 변환
                vertices.push(
                    point[0],   // X: forward -> right
                    point[2],   // Z: up -> up
                    point[1]   // Y: left -> -forward
                );

                // 거리에 따른 색상 설정
                const distance = Math.sqrt(
                    point[0] * point[0] + 
                    point[1] * point[1] + 
                    point[2] * point[2]
                );
                const color = new THREE.Color();
                color.setHSL(distance / 50.0, 1.0, 0.5);
                colors.push(color.r, color.g, color.b);
            }

            // 기존 포인트 클라우드 제거
            if (points) {
                scene.remove(points);
            }

            // 새 포인트 클라우드 생성
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 2,               // 점 크기를 더 크게
                sizeAttenuation: true,
                vertexColors: true,
                transparent: true,
                opacity: 1.0,          // 불투명도 증가
                alphaTest: 0.1
            });

            points = new THREE.Points(geometry, material);
            scene.add(points);

            // 포인트 수 업데이트
            document.getElementById('point-count').textContent = data.points.length;
        }

        // WebSocket 연결
        const ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`);
        const contentDiv = document.getElementById('content');

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            // 데이터 정보 표시
            let html = `
                <div class="data-item">
                    <h3>Header 정보</h3>
                    <p>Sequence: ${data.header.seq}</p>
                    <p>Frame ID: ${data.header.frame_id}</p>
                </div>
                <div class="data-item">
                    <h3>Point Cloud 정보</h3>
                    <p>Width: ${data.width}</p>
                    <p>Height: ${data.height}</p>
                    <p>Point Step: ${data.point_step} bytes</p>
                    <p>Data Size: ${data.data_size} bytes</p>
                </div>
            `;
            
            contentDiv.innerHTML = html;

            // 포인트 클라우드 업데이트
            updatePointCloud(data);
        };

        ws.onclose = function() {
            contentDiv.innerHTML = '연결이 종료되었습니다.';
        };

        ws.onerror = function(error) {
            contentDiv.innerHTML = `에러가 발생했습니다: ${error.message}`;
        };

        // 초기화
        init();

        // 윈도우 리사이즈 처리
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>