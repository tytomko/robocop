<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lidar Viewer</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .point-cloud-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .robot-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }

        .viewer-container {
            flex: 1;
            position: relative;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="point-cloud-container">
        <div class="page-header">
            <h2>라이다 정보</h2>
            <div class="header-actions">
                <select id="robotSelect" class="robot-select">
                    <option value="">로봇 선택</option>
                    <option value="robot1">Robot 1</option>
                    <option value="robot2">Robot 2</option>
                </select>
            </div>
        </div>

        <div id="viewer" class="viewer-container"></div>

        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let pointCloud;
        let ws = null;

        // Three.js 초기화
        function initThree() {
            const container = document.getElementById('viewer');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            camera = new THREE.PerspectiveCamera(
                75,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            // 그리드 헬퍼 추가
            const gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);
            
            // 축 헬퍼 추가
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            // 포인트 클라우드 초기화
            const geometry = new THREE.BufferGeometry();
            const material = new THREE.PointsMaterial({
                size: 0.05,
                color: 0x2196f3,
                transparent: true,
                opacity: 0.8
            });
            
            const positions = new Float32Array(3);
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            pointCloud = new THREE.Points(geometry, material);
            scene.add(pointCloud);
            
            animate();
        }

        // 웹소켓 연결
        function connectWebSocket() {
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket(`ws://${window.location.hostname}:${window.location.port}/ws`);
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'lidar_points' && data.points && data.points.length > 0) {
                        console.log('Received points:', data.points.length);
                        updatePointCloud(data.points);
                    }
                } catch (error) {
                    console.error('Error processing message:', error);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
            };
        }

        // 포인트 클라우드 업데이트
        function updatePointCloud(points) {
            if (!pointCloud || !points.length) return;
            
            try {
                const positions = new Float32Array(points.length * 3);
                
                points.forEach((point, i) => {
                    positions[i * 3] = point.x;
                    positions[i * 3 + 1] = point.y;
                    positions[i * 3 + 2] = point.z;
                });
                
                const newGeometry = new THREE.BufferGeometry();
                newGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                
                if (pointCloud.geometry) {
                    pointCloud.geometry.dispose();
                }
                pointCloud.geometry = newGeometry;
                
                pointCloud.geometry.computeBoundingSphere();
                
            } catch (error) {
                console.error('Error updating point cloud:', error);
            }
        }

        // 애니메이션 루프
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // 윈도우 리사이즈 핸들러
        function handleResize() {
            const container = document.getElementById('viewer');
            if (!container || !camera || !renderer) return;
            
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // 초기화
        window.addEventListener('load', function() {
            initThree();
            connectWebSocket();
            window.addEventListener('resize', handleResize);
        });

        // 정리
        window.addEventListener('beforeunload', function() {
            if (renderer) {
                renderer.dispose();
            }
            if (controls) {
                controls.dispose();
            }
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>